package server

import (
	"net/http"

	"github.com/gorilla/mux"
	"github.com/hyqe/brigand/internal/handlers"
	"github.com/hyqe/brigand/internal/storage"
)

// Routes defines all the routes this service offers
func Routes(
	metadataClient storage.MetadataClient,
	fileDownloader storage.FileDownloader,
	fileUploader storage.FileUploader,
	symlinkSecret string,
) http.Handler {
	r := mux.NewRouter()

	// health check for reverse proxy
	r.HandleFunc("/", handlers.NewGetHealth())

	// get docs html file. the "openapi.html" file is generated by the build process.
	// to generate it manually nodejs is required. run "./scripts/compile_openapi.sh"
	r.HandleFunc("/docs", handlers.NewGetDocs("openapi.html")).
		Methods(http.MethodGet)

	// store a file
	r.HandleFunc("/files", handlers.NewCreateFile(metadataClient, fileUploader)).
		Methods(http.MethodPost)

	// get a file by its Id.
	r.HandleFunc("/files/{fileId}", handlers.NewGetFileById(metadataClient, fileDownloader, getFileId)).
		Methods(http.MethodGet).
		Queries()

	// return a  symlink
	r.HandleFunc("/symlink/make/{name}", handlers.MakeSymlink(metadataClient, fileUploader, getFilename, symlinkSecret)).Methods(http.MethodPost)

	// return a file from symlink
	r.HandleFunc("/symlink/take/{name}", handlers.TakeSymlink(fileDownloader, symlinkSecret, storage.SymlinkFromQuery)).Methods(http.MethodGet)

	return r
}

func getFilename(r *http.Request) string {
	filename := mux.Vars(r)["name"]
	if filename == "" {
		panic("NO FILE NAME")
	}
	return filename
}

func getFileId(r *http.Request) string {
	filename := mux.Vars(r)["fileId"]
	if filename == "" {
		panic("NO FILE NAME")
	}
	return filename
}
